<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>Codire — Aufgaben</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="style.css"/>
</head>
<body>

<!-- Hamburger Menü -->
<button id="menuBtn" class="hamburger">☰</button>

<div id="sideMenu" class="side-menu">
  <button id="showTodos">Meine Aufgaben</button>
  <button id="showCompleted">Erledigte Aufgaben</button>
  <button id="btnLogout" class="small-link">Logout</button>
</div>

<div class="card-centered">
  <div class="logo">CODIRE</div>
  <h1 id="cardTitle">Meine Aufgaben</h1>

  <div id="inputContainer">
    <input id="newTodo" class="input" placeholder="Neue Aufgabe hinzufügen"/>
    <button id="addBtn" class="btn">Hinzufügen</button>
  </div>

  <ul id="todoList" class="todo-list"></ul>
  <div id="completedList" class="completed-list"></div>
</div>

<script>
const STANDARD_TASKS = [
  "Hast du deine Zeiterfassung gestartet?",
  "Hast du deine Pause gemacht?",
  "Hast du deine Zeiterfassung beendet?"
];

async function api(path, opts={}) {
  opts.headers = opts.headers || {};
  if(opts.body && typeof opts.body==='object'){
    opts.body = JSON.stringify(opts.body);
    opts.headers['Content-Type'] = 'application/json';
  }
  const res = await fetch(path, {...opts, credentials:'include'});
  if(!res.ok){
    try{const e=await res.json(); alert(e.error||'Fehler');}catch(_){alert('Fehler');}
    throw 'err';
  }
  return res.json();
}

// Logout
document.getElementById('btnLogout').addEventListener('click', async()=> {
  await api('/api/logout',{method:'POST'});
  location.href='/';
});

// Side Menu Logik
const menuBtn = document.getElementById('menuBtn');
const sideMenu = document.getElementById('sideMenu');
let showDone = false;

menuBtn.addEventListener('click', ()=> sideMenu.classList.toggle('open'));
document.getElementById('showTodos').addEventListener('click', ()=>{
  showDone=false;
  document.getElementById('cardTitle').textContent="Meine Aufgaben";
  document.getElementById('inputContainer').style.display='flex';
  document.getElementById('todoList').style.display='block';
  document.getElementById('completedList').style.display='none';
  loadTodos();
});
document.getElementById('showCompleted').addEventListener('click', ()=>{
  showDone=true;
  document.getElementById('cardTitle').textContent="Erledigte Aufgaben";
  document.getElementById('inputContainer').style.display='none';
  document.getElementById('todoList').style.display='none';
  document.getElementById('completedList').style.display='block';
  loadCompleted();
});

// Neue Aufgabe hinzufügen
document.getElementById('addBtn').addEventListener('click', async()=> {
  const txt = document.getElementById('newTodo').value.trim();
  if(!txt) return;
  await api('/api/todos',{method:'POST',body:{text:txt}});
  document.getElementById('newTodo').value='';
  loadTodos();
});

// Offene Aufgaben laden
async function loadTodos(){
  try{
    let todos = await api('/api/todos');
    
    // Standardaufgaben für den Tag hinzufügen, falls leer
    const today = new Date().toISOString().split('T')[0];
    if(!todos.some(t=>t.createdDate===today)) {
      for(const task of STANDARD_TASKS){
        await api('/api/todos',{method:'POST',body:{text:task}});
      }
      todos = await api('/api/todos');
    }

    const list = document.getElementById('todoList');
    list.innerHTML='';

    todos.forEach(t=>{
      if(t.done) return;
      const li=document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type='checkbox';
      checkbox.addEventListener('change', async()=>{
        await api(`/api/todos/${t.id}/toggle`,{method:'POST'});
        loadTodos();
      });
      const span = document.createElement('span');
      span.textContent = t.text;
      li.appendChild(checkbox);
      li.appendChild(span);
      list.appendChild(li);
    });
  }catch(e){ location.href='/'; }
}

// Erledigte Aufgaben nach Datum gruppieren
async function loadCompleted(){
  try{
    const todos = await api('/api/todos');
    const completedList = document.getElementById('completedList');
    completedList.innerHTML='';

    const grouped = {};
    todos.filter(t=>t.done).forEach(t=>{
      const date = t.doneDate?.split('T')[0] || new Date().toISOString().split('T')[0];
      if(!grouped[date]) grouped[date]=[];
      grouped[date].push(t);
    });

    for(const date in grouped){
      const summary = document.createElement('details');
      const summaryTitle = document.createElement('summary');
      summaryTitle.textContent = date;
      summary.appendChild(summaryTitle);

      grouped[date].forEach(t=>{
        const li = document.createElement('li');
        li.textContent = t.text;
        summary.appendChild(li);
      });

      completedList.appendChild(summary);
    }
  }catch(e){ location.href='/'; }
}

// Initial
loadTodos();
</script>

</body>
</html>
