<!doctype html>
<html lang = "de">
<head>
  <meta charset = "utf-8"/>
  <title>Verifizieren & Passwort</title>
  <meta name = "viewport" content = "width=device-width,initial-scale=1"/>
  <!-- Externe CSS-Datei für Layout und Styles -->
  <link rel = "stylesheet" href = "style.css"/>
</head>
<body>
  <!-- Hauptcontainer: Karte in der Mitte der Seite -->
  <div class = "card-centered">
    <!-- Logo -->
    <div class = "logo">CODIRE</div>
    <!-- Überschrift -->
    <h1>Code verifizieren & Passwort setzen</h1>
    <!-- Hier wird die E-Mail oder Telefonnummer angezeigt -->
    <p id = "showIdentifier" style = "color:#333">
    </p>
    <!-- Eingabe für den 6-stelligen Code -->
    <input id = "code" class = "input" placeholder = "6-stelliger Code"/>
    <!-- Eingabe für das neue Passwort -->
    <input id = "password" class = "input" type = "password" placeholder = "Neues Passwort (min.12, 1 Sonderzeichen)"/>
    <!-- Button: Verifizieren und Passwort speichern -->
    <button id = "btnSet" class = "btn" type = "button">Verifizieren & Speichern</button>
    <!-- Button: Zurück zur vorherigen Seite -->
    <button id = "btnBack" class = "small-link" type = "button">Zurück</button>
  </div>

<script>
  // Hilfsfunktion: Liest die Parameter aus der URL (z.B. ?identifier=...&purpose=...)
function qs(){ 
  return Object.fromEntries(new URLSearchParams(location.search)
);
}
const params = qs();

// Zeigt die Identifier-Info im Textbereich an
document.getElementById('showIdentifier').textContent = 
params.identifier ? ('Verifiziere: ' + params.identifier) : '';


// "Zurück"-Button: Unterscheidung ob Registrierung oder Passwort-Reset
document.getElementById('btnBack').addEventListener('click', 
() => {
  if (params.purpose === 'register') location.href = '/register.html';
  else location.href = '/forgot.html';
});

// Allgemeine API-Funktion für Requests
async function api(path, opts = {}) {
  opts.headers = opts.headers || {};
  if (opts.body && typeof opts.body === 'object') { 
    opts.body = JSON.stringify(opts.body); 
    opts.headers['Content-Type'] = 'application/json'; 
  }
  const res = await fetch(path, { ...opts, credentials: 'include' }
  );

  if (!res.ok) {
    const e = await res.json();
    alert(e.error || 'Fehler');
    throw 'err';
  }
  return res.json();
}

// Eventlistener: "Verifizieren & Speichern"
document.getElementById('btnSet').addEventListener('click', async () => {
  const identifier = params.identifier;
  const code = document.getElementById('code').value.trim();
  const password = document.getElementById('password').value;

  // Prüfung: Alle Felder müssen ausgefüllt sein
  if (!identifier || !code || !password) { 
    alert('Bitte Identifier, Code und Passwort eingeben'); 
    return; 
  }

  try {
    // Anfrage an die API: Code prüfen und Passwort setzen
    await api('/api/verify-and-set', {
       method: 'POST', 
       body: { identifier, code, password, purpose: params.purpose || 'register' }
      });

      // Erfolgsmeldung & Weiterleitung
    alert('Verifiziert & Passwort gesetzt — Du wirst eingeloggt.');
    location.href = '/app.html';
  } catch (e) {}
});
</script>
</body>
</html>
